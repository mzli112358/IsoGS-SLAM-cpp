# 未完成功能清单

**更新时间**: 2024-12

本文档详细列出C++重构项目中所有未完成或待完善的功能，按优先级和重要性排序。

---

## 一、关键阻塞功能（P0 - 影响系统完整性）

### ✅ 1.1 Checkpoint保存/加载集成 - 已完成
- **文件**: `src/slam/slam_loop.cpp`
- **状态**: ✅ 完整实现
- **实现内容**:
  1. 在`loadCheckpoint()`中调用`CheckpointIO::load()`加载高斯模型
  2. 在`saveCheckpoint()`中调用`CheckpointIO::save()`保存高斯模型
  3. 在`run()`函数中添加checkpoint加载逻辑（支持从checkpoint恢复）
  4. 在Config中添加`load_checkpoint_path`选项

---

## 二、高优先级功能（P1 - 功能增强）

### ✅ 2.1 Marching Cubes集成 - 已完成
- **文件**: `src/meshing/marching_cubes.cpp`
- **状态**: ✅ 完整实现（CPU版本）
- **实现内容**:
  1. 实现了基本的Marching Cubes算法（CPU版本）
  2. 支持从密度场提取网格（vertices, faces, normals）
  3. 支持可配置的iso_level和spacing
  4. 修改接口支持传递维度信息

### ✅ 2.2 网格提取器完整实现 - 已完成
- **文件**: `src/meshing/mesh_extractor.cpp`
- **状态**: ✅ 完整实现
- **实现内容**:
  1. 完整的网格提取流程：
     - 计算边界框（从高斯means）
     - 创建体素网格
     - 构建密度场（使用空间哈希加速KNN查询）
     - 从高斯参数构建逆协方差矩阵
     - 调用Marching Cubes提取网格
  2. PLY文件保存功能（ASCII格式）
  3. 支持vertices、faces、normals的完整保存

---

## 三、中优先级功能（P2 - 功能完善）

### ✅ 3.1 空间哈希半径查询 - 已完成
- **文件**: `src/utils/spatial_hash.cpp`, `cuda/kernels/spatial_hash.cu`
- **状态**: ✅ 完整实现
- **实现内容**:
  1. 实现了半径查询CUDA Kernel (`radius_query_kernel`)
  2. 实现了包装函数 (`launch_radius_query`)
  3. 实现了C++接口 (`queryRadius`)
  4. 支持查询指定半径内的所有高斯（最多256个结果）
  5. 使用固定大小缓冲区，如果超过则截断并警告

### ✅ 3.2 梯度检查工具完善 - 已完成
- **文件**: `tests/grad_check.cpp`
- **状态**: ✅ 完整实现
- **实现内容**:
  1. 实现了数值梯度计算（使用有限差分法）
  2. 实现了与解析梯度的对比
  3. 实现了详细的误差报告和统计信息（最大误差、平均误差、相对误差、失败参数数量）
  4. 支持Flat Loss和Iso Loss的梯度检查
  5. 支持与PyTorch Autograd的对比（作为参考）
  6. 提供了清晰的测试输出和通过/失败判断

### ✅ 3.3 关键帧选择算法 - 已完成
- **文件**: `include/utils/keyframe_selection.hpp`, `src/utils/keyframe_selection.cpp`
- **状态**: ✅ 完整实现
- **实现内容**:
  1. ✅ 实现了`keyframeSelectionOverlap`算法
  2. ✅ 从当前帧采样像素点并反投影到3D
  3. ✅ 将3D点投影到关键帧，计算重叠度
  4. ✅ 基于重叠度选择关键帧
  5. ✅ 已集成到Mapper中
- **对应Python**: `utils/keyframe_selection.py::keyframe_selection_overlap`

### 3.4 Mapper中的RGB/Depth梯度计算 🟡
- **文件**: `src/slam/mapper.cpp` (第358行)
- **状态**: TODO标记
- **问题**: RGB和Depth Loss的梯度计算依赖可微渲染，当前使用LibTorch Autograd
- **影响**: 可能影响性能，但功能可用
- **需要实现**:
  1. 手动计算RGB/Depth Loss的梯度（可选优化）
  2. 或者确保可微渲染正确工作
- **预计工作量**: 1-2天（可选）

### 3.5 新高斯添加的Silhouette渲染 🟡
- **文件**: `src/slam/mapper.cpp` (第177行)
- **状态**: TODO标记
- **问题**: 新高斯添加目前使用简化版本（基于深度图），未实现完整的silhouette渲染
- **影响**: 新高斯添加可能不够精确，但基本功能可用
- **需要实现**:
  1. 实现silhouette渲染
  2. 基于silhouette阈值提取新点
- **对应Python**: `scripts/splatam.py::add_new_gaussians`中的silhouette渲染部分
- **预计工作量**: 1-2天（可选）

---

## 四、评估和可视化功能（P2 - 实验支持）

### ✅ 4.1 轨迹评估（ATE等） - 已完成
- **文件**: `include/utils/trajectory_eval.hpp`, `src/utils/trajectory_eval.cpp`
- **状态**: ✅ 完整实现
- **实现内容**:
  1. ✅ ATE（Absolute Trajectory Error）计算
  2. ✅ 轨迹对齐（使用Umeyama算法）
  3. ✅ `alignTrajectories`和`evaluateATE`函数
- **对应Python**: `utils/eval_helpers.py::evaluate_ate`, `utils/eval_helpers.py::align`
- **注意**: RPE和可视化轨迹对比未实现，但核心ATE功能已完整

### 4.2 新视角合成评估 🔴
- **文件**: `src/utils/eval.cpp` 或新建 `src/utils/nvs_eval.cpp`
- **状态**: ❌ 未实现
- **需要实现**:
  1. 从checkpoint加载模型
  2. 在新视角上渲染
  3. 计算PSNR、SSIM、LPIPS等指标
  4. 批量评估多个视角
- **对应Python**: `scripts/eval_novel_view.py`, `utils/eval_helpers.py::eval_nvs`
- **预计工作量**: 3-4天

### 🟡 4.3 网格几何评估 - 核心功能实现
- **文件**: `include/utils/mesh_eval.hpp`, `src/utils/mesh_eval.cpp`
- **状态**: 🟡 核心功能实现
- **已完成**:
  1. ✅ Chamfer Distance计算
  2. ✅ F-score计算
  3. ✅ 法线一致性评估
- **待完善**:
  1. 🔴 PLY文件读取（需要实现PLY解析器）
  2. 🔴 完整的评估流程
- **对应Python**: `scripts/eval_mesh_geometry.py`

### 🟡 4.4 在线可视化 - 框架实现
- **文件**: `include/viz/online_viz.hpp`, `src/viz/online_viz.cpp`
- **状态**: 🟡 框架实现
- **已完成**:
  1. ✅ 可视化接口和框架
  2. ✅ 基础可视化类
- **待完善**:
  1. 🔴 OpenGL/OpenCV完整集成
  2. 🔴 实时渲染显示
  3. 🔴 Loss曲线绘制
  4. 🔴 交互式控制
- **对应Python**: `viz_scripts/online_recon.py`

### 🟡 4.5 最终重建可视化 - 框架实现
- **文件**: `include/viz/final_viz.hpp`, `src/viz/final_viz.cpp`
- **状态**: 🟡 框架实现
- **已完成**:
  1. ✅ 可视化接口和框架
  2. ✅ Checkpoint加载接口
- **待完善**:
  1. 🔴 OpenGL 3D查看器实现
  2. 🔴 高斯点云渲染
  3. 🔴 网格渲染
  4. 🔴 交互式控制（视角切换、缩放、旋转）
- **对应Python**: `viz_scripts/final_recon.py`

---

## 五、辅助脚本和工具（P3 - 用户体验）

### ✅ 5.1 导出PLY点云 - 已完成
- **文件**: `src/tools/export_ply.cpp`
- **状态**: ✅ 完整实现
- **实现内容**:
  1. ✅ 从checkpoint加载高斯模型
  2. ✅ 将高斯参数转换为点云格式
  3. ✅ 导出为PLY文件（ASCII格式）
  4. ✅ 支持颜色和法线
- **对应Python**: `scripts/export_ply.py`

### 🟡 5.2 离线高斯泼溅训练 - 框架实现
- **文件**: `src/tools/gaussian_splatting.cpp`
- **状态**: 🟡 框架实现
- **已完成**:
  1. ✅ 基本框架和流程
  2. ✅ Checkpoint保存
- **待完善**:
  1. 🔴 完整的训练循环实现
  2. 🔴 多视角训练逻辑
- **对应Python**: `scripts/gaussian_splatting.py`

### 🟡 5.3 SLAM后优化 - 框架实现
- **文件**: `src/tools/post_splatam_opt.cpp`
- **状态**: 🟡 框架实现
- **已完成**:
  1. ✅ 基本框架
  2. ✅ Checkpoint加载和保存
- **待完善**:
  1. 🔴 完整的全局优化流程
  2. 🔴 关键帧加载逻辑
- **对应Python**: `scripts/post_splatam_opt.py`

### 5.4 iPhone在线演示 🔴
- **文件**: 新建 `src/tools/iphone_demo.cpp`
- **状态**: ❌ 未实现
- **需要实现**:
  1. 网络通信（接收iPhone数据）
  2. 实时SLAM处理
  3. 实时可视化
  4. 数据流管理
- **对应Python**: `scripts/iphone_demo.py`, `bash_scripts/online_demo.bash`
- **预计工作量**: 5-7天（需要网络编程）

### 5.5 数据集转换工具 🔴
- **文件**: 新建 `src/tools/nerfcapture2dataset.cpp`
- **状态**: ❌ 未实现
- **需要实现**:
  1. 读取NeRFCapture数据格式
  2. 转换为标准数据集格式
  3. 保存RGB-D图像和位姿
- **对应Python**: `scripts/nerfcapture2dataset.py`
- **预计工作量**: 2-3天

---

## 六、数据集支持（P3 - 扩展性）

### 6.1 TUM数据集 🔴
- **文件**: `include/datasets/tum_dataset.hpp`, `src/datasets/tum_dataset.cpp`
- **状态**: ❌ 未实现
- **需要实现**:
  1. 读取TUM RGB-D数据格式
  2. 解析关联文件
  3. 加载RGB和深度图像
  4. 加载GT位姿
- **对应Python**: `datasets/gradslam_datasets/tum_dataset.py`
- **预计工作量**: 1-2天

### 6.2 ScanNet数据集 🔴
- **文件**: `include/datasets/scannet_dataset.hpp`, `src/datasets/scannet_dataset.cpp`
- **状态**: ❌ 未实现
- **需要实现**:
  1. 读取ScanNet数据格式
  2. 加载frames目录结构
  3. 解析内参和位姿
- **对应Python**: `datasets/gradslam_datasets/scannet_dataset.py`
- **预计工作量**: 2-3天

### 🟡 6.3 ScanNet++数据集 - 框架实现
- **文件**: `include/datasets/scannetpp_dataset.hpp`, `src/datasets/scannetpp_dataset.cpp`
- **状态**: 🟡 框架实现
- **已完成**:
  1. ✅ 基本框架和接口
- **待完善**:
  1. 🔴 完整的数据加载逻辑
  2. 🔴 去畸变图像处理
  3. 🔴 DSLR深度图加载
- **对应Python**: `datasets/gradslam_datasets/scannetpp_dataset.py`

### 🟡 6.4 ReplicaV2数据集 - 框架实现
- **文件**: `include/datasets/replica_v2_dataset.hpp`, `src/datasets/replica_v2_dataset.cpp`
- **状态**: 🟡 框架实现
- **已完成**:
  1. ✅ 基本框架和接口
- **待完善**:
  1. 🔴 完整的数据加载逻辑
  2. 🔴 多视角数据处理
- **对应Python**: `datasets/gradslam_datasets/replica_v2_dataset.py`

### 6.5 其他数据集 🔴
- **状态**: ❌ 未实现
- **数据集列表**:
  - ICL数据集
  - Azure Kinect数据集
  - Record3D数据集
  - RealSense数据集
  - AI2Thor数据集
  - NeRFCapture数据集
- **预计工作量**: 每个数据集1-2天

---

## 七、工具函数（P3 - 代码质量）

### ✅ 7.1 种子设置 - 已完成
- **文件**: `include/utils/common_utils.hpp`, `src/utils/common_utils.cpp`
- **状态**: ✅ 完整实现
- **实现内容**:
  1. ✅ 设置随机种子
  2. ✅ 设置CUDA随机种子
  3. ✅ 设置LibTorch随机种子
  4. ✅ 设置确定性模式
- **对应Python**: `utils/common_utils.py::seed_everything`

### ✅ 7.2 参数转换工具 - 已完成
- **文件**: `include/utils/common_utils.hpp`, `src/utils/common_utils.cpp`
- **状态**: ✅ 完整实现
- **实现内容**:
  1. ✅ 参数转CPU
  2. ✅ 参数转Numpy格式（用于Python交互）
- **对应Python**: `utils/common_utils.py::params2cpu`

### 7.3 完整的评估流程 🔴
- **文件**: `src/utils/eval.cpp`
- **状态**: 🟡 部分实现
- **需要实现**:
  1. 批量评估多个场景
  2. 生成评估报告
  3. 保存评估结果
  4. 可视化评估指标
- **对应Python**: `utils/eval_helpers.py::eval`的完整流程
- **预计工作量**: 2-3天

---

## 八、性能优化（P4 - 后续优化）

### 8.1 Marching Cubes CUDA版本 🔵
- **文件**: `cuda/kernels/marching_cubes.cu`
- **状态**: ❌ 未实现
- **需要实现**:
  1. CUDA版本的Marching Cubes
  2. 并行处理多个体素
  3. 优化内存访问
- **预计工作量**: 3-5天

### 8.2 性能Profiling和优化 🔵
- **状态**: ❌ 未开始
- **需要实现**: 
  - 使用NVIDIA Nsight进行性能分析
  - Kernel优化
  - 内存访问优化
  - 批处理优化
- **预计工作量**: 持续优化

### 8.3 多线程优化 🔵
- **状态**: ❌ 未开始
- **需要实现**:
  1. Tracking和Mapping并行
  2. 数据加载并行
  3. 渲染和优化并行
- **预计工作量**: 5-7天

---

## 九、单元测试（P4 - 代码质量）

### 9.1 单元测试覆盖 🔵
- **状态**: 框架完成（只有grad_check.cpp）
- **需要实现**: 
  - 各模块的单元测试
  - 集成测试
  - 性能基准测试
  - 回归测试
- **预计工作量**: 持续添加

---

## 十、功能完整性评估

### 10.1 可以运行但功能不完整
- ✅ SLAM循环可以运行（使用GT位姿或优化位姿）
- ✅ Tracking可以运行（包括SSIM Loss）
- ✅ **Mapping可以完整优化**（优化器已集成）
- ✅ **Densification和Pruning已实现**
- ✅ **Checkpoint保存/加载已集成到SLAM循环**
- 🟡 关键帧选择使用简化版本（缺少完整算法）

### 10.2 核心算法状态
- ✅ Flat Loss: 完整
- ✅ Iso Loss: 核心功能完整
- ✅ 空间哈希: KNN查询完整，**半径查询已实现** ✅
- ✅ **Densification: 完整实现**
- ✅ **Pruning: 完整实现**

### 10.3 工具模块状态
- ✅ Checkpoint I/O: 完整（已集成到SLAM循环）
- ✅ 点云提取: 完整
- ✅ 优化器: 完整实现并已集成
- ✅ 空间哈希: KNN查询完整，**半径查询已实现** ✅
- 🟡 评估工具: PSNR和SSIM完整，但缺少轨迹评估和新视角合成评估

### 10.4 网格提取状态
- ✅ Marching Cubes: 完整实现（CPU版本）
- ✅ 网格提取器: 完整实现
- ✅ PLY保存: 完整实现

### 10.5 缺失的主要功能
- ❌ 关键帧选择算法（使用简化版本）
- ❌ 轨迹评估（ATE等）
- ❌ 新视角合成评估
- ❌ 网格几何评估
- ❌ 可视化工具（在线和最终重建）
- ❌ 辅助脚本（导出PLY、离线训练、后优化等）
- ❌ 更多数据集支持（只有Replica）

---

## 十一、优先级总结

### ✅ 已完成（关键阻塞和高优先级）
1. ✅ **Checkpoint保存/加载集成** - 已完成
2. ✅ **Marching Cubes集成** - 已完成
3. ✅ **网格提取器完整实现** - 已完成
4. ✅ **空间哈希半径查询** - 已完成
5. ✅ **梯度检查工具** - 已完成
6. ✅ **关键帧选择算法** - 已完成
7. ✅ **轨迹评估** - 已完成
8. ✅ **导出PLY点云工具** - 已完成
9. ✅ **工具函数补充** - 已完成

### 中优先级（P2）- 框架已实现，需要完善
10. 🟡 **新视角合成评估** - 框架实现（需要完善LPIPS和完整流程）
11. 🟡 **网格几何评估** - 核心功能实现（需要PLY解析器）
12. 🟡 **可视化工具** - 框架实现（需要OpenGL/OpenCV完整集成）
13. 🟡 **离线训练和后优化工具** - 框架实现（需要完善训练循环）
14. 🟡 **数据集支持** - 框架实现（TUM、ScanNet等需要完善文件加载）
15. **Mapper梯度计算优化** - 性能优化（可选）
16. **Silhouette渲染** - 功能增强（可选）

### 低优先级（P3）
13. **辅助脚本** - 用户体验（导出PLY、离线训练、后优化等）
14. **更多数据集支持** - 扩展性（TUM、ScanNet等）
15. **工具函数** - 代码质量（种子设置、参数转换等）

### 后续优化（P4）
16. **性能优化** - 持续改进
17. **单元测试** - 代码质量
18. **Marching Cubes CUDA版本** - 性能优化

---

## 十二、预计完成时间

- **P0功能**: ✅ 已完成
- **P1功能**: ✅ 已完成
- **P2功能**: 15-25天（取决于并行开发程度）
- **P3功能**: 20-30天（取决于数据集数量）
- **P4功能**: 持续优化

---

**总结**: 
- ✅ **所有关键阻塞功能（P0）和高优先级功能（P1）已全部完成！**
- ✅ **关键帧选择算法已完成** - 基于重叠度的关键帧选择
- ✅ **轨迹评估已完成** - ATE计算和轨迹对齐
- ✅ **导出PLY工具已完成** - 从checkpoint导出点云
- ✅ **工具函数补充已完成** - 种子设置和参数转换
- ✅ **Checkpoint集成已完成** - 支持保存/加载和断点续跑
- ✅ **网格提取功能已完成** - Marching Cubes + 网格提取器 + PLY保存

系统现在可以完整运行SLAM流程，包括：
- 完整的Mapping优化、Densification和Pruning
- 空间哈希加速的Iso Loss
- SSIM Loss提升Tracker精度
- 性能优化的Loss计算
- **Checkpoint保存/加载和断点续跑**
- **从高斯模型提取网格并导出PLY文件**
- **基于重叠度的关键帧选择算法**
- **轨迹评估工具（ATE）**

**框架已实现，需要完善的功能**：
1. 🟡 **新视角合成评估** - 框架已实现，需要完善LPIPS和完整流程
2. 🟡 **网格几何评估** - 核心功能已实现，需要PLY解析器
3. 🟡 **可视化工具** - 框架已实现，需要OpenGL/OpenCV完整集成
4. 🟡 **离线训练和后优化工具** - 框架已实现，需要完善训练循环
5. 🟡 **数据集支持** - TUM、ScanNet等框架已实现，需要完善文件加载逻辑
6. **Mapper梯度计算优化** - 性能优化（可选）
7. **Silhouette渲染** - 功能增强（可选）
8. **更多数据集支持** - ICL、Azure Kinect等（扩展性）
9. **性能优化和单元测试** - 代码质量
